<!DOCTYPE html>  
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Segwik AI – Contact Details</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --ink:#243048; --muted:#667085; --line:#e6ebf2;
    --accent:#0F2D56; --btn:#1d305e; --pill:#eef4ff; --pill-border:#cfe1ff;
    --phone-w:430px; --phone-h:800px; --footer-h:76px; --status-h:46px; --head-h:52px;

    /* NEW animation tuning */
    --slide-dur:.36s;
    --slide-ease:cubic-bezier(.22,.61,.36,1);
    --acc-dur:.28s;
    --acc-ease:cubic-bezier(.25,.8,.25,1);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);
    font-family:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,'Helvetica Neue',Arial,sans-serif}
  .wrap{display:flex;align-items:center;justify-content:center;min-height:100%;padding:18px}

  .phone{width:var(--phone-w);height:var(--phone-h);background:#fff;border-radius:36px;
    box-shadow:0 20px 60px rgba(0,0,0,.12),0 8px 16px rgba(0,0,0,.08);position:relative;
    overflow:hidden;border:8px solid #111;display:flex;flex-direction:column}
  .notch{position:absolute;top:8px;left:50%;transform:translateX(-50%);width:180px;height:30px;background:#111;border-radius:20px 20px 28px 28px;z-index:10}

  .status{height:var(--status-h);padding:0 16px;display:flex;align-items:center;justify-content:center;gap:8px;border-bottom:1px solid var(--line);background:#fff;z-index:5}
  .status .logo{display:flex;align-items:center;gap:8px;font-weight:700;letter-spacing:.3px}
  .status .logo .bot{width:22px;height:22px;border-radius:50%;background:linear-gradient(145deg,#e9f0ff,#dfe1ff);display:grid;place-items:center;border:1px solid #c9d7ff}
  .status .logo .bot::before{content:"";width:10px;height:6px;border-radius:3px;display:block;background:#0F2D56;box-shadow:0 0 0 2px #b7ccff inset}

  .page-head{position:sticky; top:0; z-index:4; background:#fff; border-bottom:1px solid var(--line)}
  .page-head.hidden{display:none}
  .page-title{height:var(--head-h); padding:12px 16px 8px; display:flex; align-items:center; justify-content:space-between}
  .left-row{display:flex;align-items:center;gap:10px}
  .back{width:32px;height:32px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;display:grid;place-items:center;cursor:pointer}
  .back svg{width:18px;height:18px}
  .title-text{font-weight:800;color:var(--accent);font-size:18px}

  .content{flex:1; overflow:auto; background:#f6f8fb; padding-bottom:var(--footer-h);}

  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px}
  .card-head{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .card-head .emoji{font-size:20px}
  .card-title{font-weight:800;font-size:16px}
  .card-body{font-size:13px;color:#667085;line-height:1.5;margin-bottom:10px}
  .action-center{display:flex;justify-content:center}
  .action-text{font-weight:700;color:#0F2D56;cursor:pointer;text-align:center;font-size:13px}

  .tray{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:8px;border-top:1px solid var(--line);background:#fff;position:sticky;bottom:0}
  .ibtn{padding:8px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;display:grid;place-items:center;font-size:11px;cursor:pointer}
  .ibtn svg{width:17px;height:17px}
  svg{stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

  /* ---------- Journey Picker (bottom sheet INSIDE phone) ---------- */
  .overlay{position:absolute;inset:0;background:rgba(15,45,86,.28);display:none;align-items:flex-end;z-index:50}
  .overlay.show{display:flex}
  .sheet{width:100%;max-height:72%;background:#fff;border-top:1px solid var(--pill-border);
    border-radius:18px 18px 0 0;box-shadow:0 18px 40px rgba(15,45,86,.18);
    padding:14px 14px 10px;transform:translateY(100%);transition:transform .25s ease}
  .overlay.show .sheet{transform:translateY(0)}
  .sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .sheet-title{font-weight:800;color:#0F2D56}
  .x{width:28px;height:28px;border-radius:8px;border:1px solid #e4ecff;background:#eef4ff;display:grid;place-items:center;cursor:pointer}
  .x:hover{filter:brightness(.96)}
  #journeyBody{overflow:auto; padding-bottom:80px}

  /* Accordion categories */
  .acc{border:1px solid #e6ebf2;border-radius:12px;background:#fff;margin-bottom:10px;overflow:hidden}
  .acc-head{display:flex;align-items:center;justify-content:space-between;padding:12px 12px;cursor:pointer}
  .acc-title{font-weight:800;color:#243048;font-size:14px}
  .acc-head svg{width:18px;height:18px;transition:transform var(--acc-dur) var(--acc-ease);opacity:.8}
  .acc.open .acc-head svg{transform:rotate(90deg)}
  .acc-panel{
    overflow:hidden;
    max-height:0;
    transition:max-height var(--acc-dur) var(--acc-ease), padding var(--acc-dur) var(--acc-ease);
    will-change:max-height;
  }

  /* Journey item list */
  .jitem{display:flex;align-items:center;justify-content:space-between;padding:12px;border-top:1px solid #eef2f7;cursor:pointer;gap:8px}
  .jitem .name{font-size:13px;color:#243048;flex:1;min-width:0}
  .jitem svg{width:16px;height:16px;opacity:.6}

  .jdetail{background:#f8fbff;border-top:1px dashed #dbe7ff;padding:10px 12px;line-height:1.4}
  .jdetail .h{font-weight:800;color:#0F2D56;margin-bottom:6px}
  .jdetail .p{font-size:12px;color:#475569;margin:4px 0}
  .add-btn{margin-top:10px;display:inline-block;background:#1d305e;color:#fff;border:1px solid #1d305e;border-radius:10px;padding:8px 12px;font-size:12px;cursor:pointer}
  .add-btn.small{margin-top:0;padding:6px 10px;font-size:12px;border-radius:8px;flex:0 0 120px;text-align:center}

  /* ---------- NEW: In-app screen navigation (slide in/out) ---------- */
  .screens{position:relative;flex:1;overflow:hidden;background:#f6f8fb}
  .screen{
    position:absolute; inset:0; display:flex; flex-direction:column; background:#f6f8fb;
    transform:translateX(0); opacity:1; pointer-events:auto;
    transition:transform var(--slide-dur) var(--slide-ease), opacity var(--slide-dur) ease-out;
    will-change:transform, opacity;
  }
  .screen.hidden{opacity:0; pointer-events:none}
  .screen.off-right{transform:translateX(100%); opacity:0; pointer-events:none}
  .screen.off-left{transform:translateX(-10%); opacity:.0; pointer-events:none}

  /* Picker screen specific */
  .picker-head{position:sticky; top:0; z-index:4; background:#fff; border-bottom:1px solid var(--line)}
  .picker-title{height:var(--head-h); padding:12px 16px 8px; display:flex; align-items:center; justify-content:space-between}
  .search-wrap{padding:10px 12px;background:#fff;border-bottom:1px solid var(--line)}
  .search-wrap input{
    width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:14px; outline:none;
    background:#f8fafc;
  }
  .picker-content{flex:1; overflow:auto; background:#f6f8fb; padding-bottom:var(--footer-h);}

  /* Details screen */
  .details-body{padding:12px}
  .details-card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0}
  .details-card .h{font-weight:800;color:#0F2D56;margin-bottom:8px}
  .details-card .p{font-size:13px;color:#475569;margin:6px 0;line-height:1.5}
  .details-actions{display:flex;gap:10px; padding:8px 12px}
  .primary-btn{background:#1d305e;color:#fff;border:1px solid #1d305e;border-radius:12px;padding:10px 14px;font-size:13px;cursor:pointer}
  .secondary-btn{background:#fff;color:#0F2D56;border:1px solid var(--line);border-radius:12px;padding:10px 14px;font-size:13px;cursor:pointer}
  .mini-btn{padding:6px 10px;font-size:12px;border-radius:8px}

  /* Small inline list for selected journeys on main screen */
  .journey-list{list-style:none;margin:8px 0 0;padding:0}
  .journey-list li{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#f8fbff;margin-top:8px;font-size:13px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .journey-pill{padding:4px 8px;border-radius:999px;border:1px solid var(--pill-border);background:var(--pill);font-weight:700;font-size:11px;color:#0F2D56}
  .journey-list .view-btn{flex:0 0 120px;text-align:center}

  /* ---------- NEW: Date Modal ---------- */
  .center-overlay{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(15,45,86,.28); z-index:60}
  .center-overlay.show{display:flex}
  .dialog{width:86%; max-width:360px; background:#fff; border:1px solid var(--pill-border); border-radius:16px; box-shadow:0 18px 40px rgba(15,45,86,.18); padding:14px}
  .dialog-head{font-weight:800;color:#0F2D56;margin-bottom:8px}
  .dialog-body{font-size:13px;color:#475569;margin-bottom:12px}
  .dialog-row{display:flex; gap:10px; justify-content:flex-end}
  .dialog input[type="date"]{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#f8fafc; font-size:13px; margin-top:6px}

  /* ----------- NEW: Journey Workspace screen (280ms ease-in-out) ----------- */
  .screen.workspace{
    transition:transform 280ms ease-in-out, opacity 280ms ease-in-out;
  }
  .ws-head{position:sticky; top:0; z-index:4; background:#fff; border-bottom:1px solid var(--line)}
  .ws-title{height:var(--head-h); padding:12px 16px 8px; display:flex; align-items:center; justify-content:space-between}
  .ws-title .title-text{font-weight:800;color:var(--accent);font-size:18px}

  .ws-content{flex:1; overflow:auto; background:#f6f8fb; padding:12px 12px 88px}

  .phase{border:1px solid var(--line); border-radius:14px; background:#fff; margin-bottom:10px; overflow:hidden}
  .phase-head{display:flex; align-items:center; justify-content:space-between; padding:12px; cursor:pointer}
  .phase-title{font-weight:800; color:#243048; font-size:14px}
  .phase-meta{font-size:12px; color:#667085}
  .pill{display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--pill-border); background:var(--pill); font-weight:700; font-size:11px; color:#0F2D56}
  .phase-actions{display:flex; gap:8px; align-items:center}
  .phase-complete{background:#1d305e;color:#fff;border:1px solid #1d305e;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}

  .phase-panel{overflow:hidden; max-height:0; transition:max-height 280ms ease-in-out, padding 280ms ease-in-out}
  .phase.open .phase-panel{ /* max-height set inline for buttery anim */ }

  .task{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-top:1px solid #eef2f7}
  .task .t-left{min-width:0}
  .task .t-title{font-weight:700; color:#243048; font-size:13px}
  .task .t-meta{font-size:12px; color:#667085}
  .task .t-actions{display:flex; gap:8px; align-items:center}
  .btn-start{background:#fff;color:#0F2D56;border:1px solid var(--line);border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
  .kebab{width:28px;height:28px;border:1px solid var(--line);border-radius:8px;background:#f8fafc;display:grid;place-items:center;cursor:pointer}
  .kebab:after{content:'⋯';font-size:18px;line-height:0;margin-top:-2px}

  .kebab-menu{position:absolute; background:#fff; border:1px solid var(--line); border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:6px; display:none; z-index:80}
  .kebab-menu.show{display:block}
  .kebab-menu button{display:block; width:100%; text-align:left; background:#fff; border:0; padding:8px 10px; font-size:12px; border-radius:8px; cursor:pointer}
  .kebab-menu button:hover{background:#f6faff}

  /* Smart Task bottom sheet */
  .ws-overlay{position:absolute; inset:0; display:none; align-items:flex-end; background:rgba(15,45,86,.28); z-index:70}
  .ws-overlay.show{display:flex}
  .ws-sheet{width:100%; background:#fff; border-top:1px solid var(--pill-border); border-radius:18px 18px 0 0; box-shadow:0 18px 40px rgba(15,45,86,.18); padding:12px; transform:translateY(100%); transition:transform 250ms ease}
  .ws-overlay.show .ws-sheet{transform:translateY(0)}
  .ws-sheet .h{font-weight:800;color:#0F2D56;margin-bottom:8px}
  .ws-sheet .field{width:100%; border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-size:13px; min-height:72px; background:#f8fafc}
  .ws-sheet .row{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="phone">
    <div class="notch"></div>
    <div class="status">
      <div class="logo"><span class="bot"></span><span>SEGWiK</span></div>
    </div>

    <!-- ORIGINAL MAIN PAGE HEADER -->
    <div class="page-head" id="mainHeader">
      <div class="page-title">
        <div class="left-row">
          <div class="back" onclick="history.back()">
            <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
          </div>
          <div class="title-text">Contact Details</div>
        </div>
      </div>
    </div>

    <!-- NEW: SCREEN STACK -->
    <div class="screens" id="screenStack">
      <!-- Screen 1: Main Contact Details -->
      <div class="screen" id="screen-main">
        <div class="content">




          <section class="card" id="journeyCard">
            <div class="card-head"><span class="emoji">📈</span><div class="card-title">Journey Status</div></div>
            <div class="card-body" id="journeyCardBody">
              <div id="journeyPlaceholder">This contact doesn't have any journeys. Want to add any journeys?</div>
              <ul class="journey-list" id="journeyList" style="display:none;"></ul>
            </div>
            <div class="action-center">
              <div class="action-text" id="addJourneyLink">+ Add Journey</div>
            </div>
          </section>


        </div>
      </div>

      <!-- Screen 2: Journey Picker -->
      <div class="screen off-right hidden" id="screen-picker" aria-hidden="true">
        <div class="picker-head">
          <div class="picker-title">
            <div class="left-row">
              <div class="back" id="pickerBackBtn">
                <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
              </div>
              <div class="title-text">Add Journey</div>
            </div>
          </div>
          <div class="search-wrap">
            <input type="search" id="journeySearch" placeholder="Search journeys or categories..." />
          </div>
        </div>
        <div class="picker-content">
          <div id="pickerAccordion" style="padding:12px"></div>
        </div>
      </div>

      <!-- Screen 3: Journey Details -->
      <div class="screen off-right hidden" id="screen-details" aria-hidden="true">
        <div class="picker-head">
          <div class="picker-title">
            <div class="left-row">
              <div class="back" id="detailsBackBtn">
                <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
              </div>
              <div class="title-text" id="detailsTitle">Journey Details</div>
            </div>
          </div>
        </div>
        <div class="details-body">
          <div class="details-card">
            <div class="h" id="detailsName">Journey Name</div>
            <div class="p"><strong>Best For:</strong> <span id="detailsBestFor"></span></div>
            <div class="p"><strong>Ideal Contacts:</strong> <span id="detailsIdeal"></span></div>
            <div class="p"><strong>Goal:</strong> <span id="detailsGoal"></span></div>
          </div>
          <div class="details-actions">
            <button class="primary-btn" id="detailsAddBtn">Add to Journey</button>
            <button class="secondary-btn" id="detailsCancelBtn">Cancel</button>
          </div>
        </div>
      </div>

      <!-- NEW Screen 4: Journey Workspace -->
      <div class="screen off-right hidden workspace" id="screen-workspace" aria-hidden="true">
        <div class="ws-head">
          <div class="ws-title">
            <div class="left-row">
              <div class="back" id="wsBackBtn">
                <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
              </div>
              <div class="title-text" id="wsTitle">Journey Workspace</div>
            </div>
          </div>
        </div>
        <div class="ws-content">
          <div id="wsEmpty" style="display:none; color:#667085; font-size:13px">No phases yet. Add journeys and phases here.</div>
          <div id="wsPhases"></div>
        </div>
      </div>
    </div>
    <!-- /NEW: SCREEN STACK -->

    <div class="tray" id="footer-tray">
      <div class="ibtn" data-icon="phone"></div>
      <div class="ibtn" data-icon="mail"></div>
      <div class="ibtn" data-icon="chat"></div>
      <div class="ibtn" data-icon="calendar"></div>
      <div class="ibtn" data-icon="note"></div>
    </div>

    <!-- Journey Picker Overlay (inside phone) -->
    <div id="journeyOverlay" class="overlay" onclick="overlayClose(event,'journeyOverlay')" role="dialog" aria-modal="true">
      <div class="sheet" onclick="event.stopPropagation()">
        <div class="sheet-head">
          <div class="sheet-title">Add Journey</div>
          <div class="x" onclick="closeSheet('journeyOverlay')">×</div>
        </div>
        <div id="journeyBody"></div>
      </div>
    </div>
    <!-- /Journey Picker Overlay -->

    <!-- NEW: Centered Date Modal -->
    <div id="dateModal" class="center-overlay" onclick="if(event.target.id==='dateModal'){closeDateModal(false)}">
      <div class="dialog" onclick="event.stopPropagation()">
        <div class="dialog-head">Estimated Journey Completion Date</div>
        <div class="dialog-body">
          <input type="date" id="dateInput">
        </div>
        <div class="dialog-row">
          <button class="secondary-btn" id="dateNotNow">Not Now</button>
          <button class="primary-btn" id="dateContinue">Continue</button>
        </div>
      </div>
    </div>
    <!-- /Centered Date Modal -->

    <!-- NEW: Smart Task Bottom Sheet -->
    <div id="taskModal" class="ws-overlay" onclick="if(event.target.id==='taskModal'){closeTaskModal()}">
      <div class="ws-sheet" onclick="event.stopPropagation()">
        <div class="h" id="taskModalTitle">Compose Email</div>
        <textarea class="field" id="taskNotes" placeholder="Write your email..."></textarea>
        <div class="row">
          <button class="secondary-btn" id="taskCancelBtn">Cancel</button>
          <button class="primary-btn" id="taskSendBtn">Send Email</button>
        </div>
      </div>
    </div>
    <!-- /Smart Task Bottom Sheet -->

    <!-- Kebab context menu -->
    <div id="kebabMenu" class="kebab-menu">
      <button data-act="start">Start task</button>
      <button data-act="assign">Assign task</button>
      <button data-act="complete">Complete task</button>
      <button data-act="queue">Queue task</button>
      <button data-act="cancel">Cancel task</button>
      <button data-act="pause">Pause task</button>
    </div>

  </div>
</div>

<script>
/* footer icons (same set) */
function icon(name){
  switch(name){
    case 'mail': return `<svg viewBox="0 0 24 24"><path d="M4 6h16v12H4z"/><path d="M4 7l8 6 8-6"/></svg>`;
    case 'phone': return `<svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0  0 1-6-6 19.79 19.79 0  0 1-3.07-8.67A2 2 0  0 1 4.11 2h3a2 2 0  0 1 2 1.72c.12 .9.3 1.77.57 2.61a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0  0 0 6 6l1.47-1.11a2 2 0 0 1 2.11-.45c.84 .27 1.71 .45 2.61 .57A2 2 0  0 1 22 16.92z"/></svg>`;
    case 'chat': return `<svg viewBox="0 0 24 24"><path d="M21 15a4 4 0  0 1-4 4H8l-5 3V7a4 4 0  0 1 4-4h10a4 4 0  0  1 4 4z"/></svg>`;
    case 'calendar': return `<svg viewBox="0 0 24 24"><path d="M3 8h18M5 4h14v16H5z"/><path d="M16 2v4M8 2v4"/></svg>`;
    case 'note': return `<svg viewBox="0 0 24 24"><path d="M4 3h14l2 2v16H4z"/><path d="M9 13h6M9 9h6M9 17h3"/></svg>`;
  }
}
document.querySelectorAll('#footer-tray [data-icon]').forEach(el=>{
  el.innerHTML = icon(el.getAttribute('data-icon')) || '';
});

/* ---------- Journey data with descriptions ---------- */
const JOURNEYS = [
  {
    cat: 'Contact Reactivation',
    items: [
      {
        name: 'Cold/General Meeting Request Journey',
        bestFor: 'When interest is unclear or low, but you still want to test engagement.',
        ideal: 'New contacts, casual networking connections, or unqualified leads.',
        goal: 'Test interest and gauge engagement to decide if further conversations are worthwhile.'
      },
      {
        name: 'Business Card Reactivate Journey',
        bestFor: 'Reaching out to old, very old, or unknown contacts you are rediscovering.',
        ideal: 'Names from a stack of business cards, outdated lists, or long-idle phone entries.',
        goal: 'Lightly reintroduce yourself, acknowledge the time gap, and reopen the door.'
      }
    ]
  },
  {
    cat: 'Event Follow-ups',
    items: [
      {
        name: 'Event High-Value Sales Meeting Journey',
        bestFor: 'Securing a decision-making meeting quickly after meeting a highly qualified contact.',
        ideal: 'Senior decision-makers, high-value prospects, or warm referrals met at an event.',
        goal: 'Secure a sales/decision meeting ASAP with a top-priority contact.'
      },
      {
        name: 'Event Warm Reconnect Journey',
        bestFor: 'Following up after reconnecting with someone you already know at an event.',
        ideal: 'Familiar contacts, clients, or acquaintances you ran into at a gathering.',
        goal: 'Schedule a face-to-face or virtual catch-up without urgency.'
      },
      {
        name: 'Event Dormant Reconnect Journey',
        bestFor: 'Re-establishing communication with someone from your past network after a long gap.',
        ideal: 'Dormant contacts, former clients, or colleagues from phone/LinkedIn (not tied to a recent event).',
        goal: 'Reopen the relationship with inactive or past contacts.'
      },
      {
        name: 'Event New Contact Follow-Up Journey',
        bestFor: 'Following up with brand-new people met for the first time at an event.',
        ideal: 'Fresh introductions from conferences, trade shows, meetups, or mixers.',
        goal: 'Continue the conversation and explore business potential.'
      },
      {
        name: 'Event Acknowledgment Journey',
        bestFor: 'Lightly acknowledging someone you just met without pushing for a meeting.',
        ideal: 'Casual event contacts, weak-fit prospects, or very early introductions.',
        goal: 'Maintain goodwill without pressure.'
      },
      {
        name: 'Event Urgent Demo Journey',
        bestFor: 'Responding quickly when a lead wants to see a demo.',
        ideal: 'Inbound leads, hot prospects, or people with immediate needs.',
        goal: 'Quickly confirm and schedule a demo.'
      }
    ]
  }
];

/* ---------- Overlay helpers (preserved; not used for new screens) ---------- */
function showSheet(id){ document.getElementById(id).classList.add('show'); }
function closeSheet(id){ document.getElementById(id).classList.remove('show'); }
function overlayClose(e,id){ if(e.target.id===id) closeSheet(id); }

/* ---------- Build accordion UI for new picker screen ---------- */
function openJourneyPicker(){
  buildPickerAccordion();
  navigateTo('screen-picker');
}

/* State for accordion open/close (used by both old/new renders) */
let currentOpen = null;   // index of open category
let currentDetail = null; // {i,j,el}

/* ---------- NEW: Screen Navigation ---------- */
const screens = {
  main: document.getElementById('screen-main'),
  picker: document.getElementById('screen-picker'),
  details: document.getElementById('screen-details'),
  workspace: document.getElementById('screen-workspace')
};
let navStack = ['screen-main']; // simple stack of ids

function updateHeaderVisibility(){
  const header = document.getElementById('mainHeader');
  const topId = navStack[navStack.length - 1];
  header.classList.toggle('hidden', topId !== 'screen-main');
}

function navigateTo(id){
  const currentId = navStack[navStack.length - 1];
  if(currentId === id) return;

  const from = document.getElementById(currentId);
  const to = document.getElementById(id);

  to.classList.remove('hidden','off-left');
  to.classList.add('off-right');

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    from.classList.add('off-left');
    to.classList.remove('off-right');
  }));

  setTimeout(()=>{
    from.classList.add('hidden');
    from.classList.remove('off-left');
  }, 380);

  navStack.push(id);
  updateHeaderVisibility();
}

function navigateBack(){
  if(navStack.length <= 1) return;
  const fromId = navStack.pop();
  const toId = navStack[navStack.length - 1];

  const from = document.getElementById(fromId);
  const to = document.getElementById(toId);

  to.classList.remove('hidden','off-left','off-right');

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    from.classList.add('off-right');
  }));

  setTimeout(()=>{
    from.classList.add('hidden');
    from.classList.remove('off-right');
  }, 380);

  updateHeaderVisibility();
}

/* ---------- NEW: Build Picker (Screen 2) ---------- */
function buildPickerAccordion(filterText=''){
  const host = document.getElementById('pickerAccordion');
  const query = (filterText || '').trim().toLowerCase();

  const blocks = JOURNEYS.map((block, i) => {
    const catMatch = block.cat.toLowerCase().includes(query);
    const items = block.items.filter(it =>
      !query ||
      catMatch ||
      it.name.toLowerCase().includes(query)
    );

    if(!items.length) return '';

    return `
      <div class="acc" data-idx="${i}">
        <div class="acc-head" onclick="toggleCategoryPicker(${i})" aria-expanded="false">
          <div class="acc-title">${block.cat}</div>
          <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
        </div>
        <div class="acc-panel">
          ${items.map((it)=>`
            <div class="jitem" onclick="openJourneyDetails(${i}, ${getOriginalIndex(i,it.name)})">
              <div class="name">${it.name}</div>
              <button class="add-btn small" onclick="event.stopPropagation(); promptAddFromPicker(${i}, ${getOriginalIndex(i,it.name)})">Add to Journey</button>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }).join('');

  host.innerHTML = blocks;

  currentOpen = null;
  if(query){
    JOURNEYS.forEach((block, i)=>{
      const hasMatch = block.cat.toLowerCase().includes(query) ||
        block.items.some(it => it.name.toLowerCase().includes(query));
      if(hasMatch){ setOpenPicker(i, true, true); }
    });
    const firstMatch = host.querySelector('.jitem');
    if(firstMatch){
      setTimeout(()=>firstMatch.scrollIntoView({behavior:'smooth', block:'start'}), 0);
    }
  }
}

/* Helper to find original index j by name within category i */
function getOriginalIndex(i, name){
  return JOURNEYS[i].items.findIndex(it => it.name === name);
}

function toggleCategoryPicker(i){
  if(currentOpen !== null && currentOpen !== i){
    setOpenPicker(currentOpen, false);
    setOpenPicker(i, true);
    currentOpen = i;
  }else{
    const acc = document.querySelector(`#pickerAccordion .acc[data-idx="${i}"]`);
    const isOpen = acc && acc.classList.contains('open');
    setOpenPicker(i, !isOpen);
    currentOpen = !isOpen ? i : null;
  }
}

function setOpenPicker(i, open, immediate=false){
  const acc = document.querySelector(`#pickerAccordion .acc[data-idx="${i}"]`);
  if(!acc) return;
  const head = acc.querySelector('.acc-head');
  const panel = acc.querySelector('.acc-panel');

  if(open){
    acc.classList.add('open');
    head.setAttribute('aria-expanded','true');
    panel.style.paddingTop = '0px'; panel.style.paddingBottom = '0px';
    panel.style.maxHeight = panel.scrollHeight + 'px';
    if(immediate){
      panel.addEventListener('transitionend', function onEnd(e){
        if(e.propertyName === 'max-height'){
          panel.style.maxHeight = 'none';
          panel.removeEventListener('transitionend', onEnd);
        }
      });
    }else{
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        panel.style.maxHeight = panel.scrollHeight + 'px';
      }));
      panel.addEventListener('transitionend', function onEnd(e){
        if(e.propertyName === 'max-height'){
          panel.style.maxHeight = 'none';
          panel.removeEventListener('transitionend', onEnd);
        }
      });
    }
  }else{
    head.setAttribute('aria-expanded','false');
    if(getComputedStyle(panel).maxHeight === 'none'){
      panel.style.maxHeight = panel.scrollHeight + 'px';
    }
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      panel.style.maxHeight = '0px';
    }));
    acc.classList.remove('open');
  }
}

/* Search behavior with unfold on match */
document.getElementById('journeySearch').addEventListener('input', (e)=>{
  buildPickerAccordion(e.target.value);
});

/* ---------- NEW: Journey Details (Screen 3) ---------- */
let detailsContext = {i:null,j:null};

function openJourneyDetails(i,j){
  detailsContext = {i,j};
  const data = JOURNEYS[i].items[j];
  document.getElementById('detailsTitle').textContent = 'Journey Details';
  document.getElementById('detailsName').textContent = data.name;
  document.getElementById('detailsBestFor').textContent = data.bestFor;
  document.getElementById('detailsIdeal').textContent = data.ideal;
  document.getElementById('detailsGoal').textContent = data.goal;

  navigateTo('screen-details');
}

/* Add journey from details screen -> show date modal */
document.getElementById('detailsAddBtn').addEventListener('click', ()=>{
  const {i,j} = detailsContext;
  if(i===null || j===null) return;
  const data = JOURNEYS[i].items[j];
  openDateModal({source:'details', name:data.name});
});

/* Cancel button on details screen */
document.getElementById('detailsCancelBtn').addEventListener('click', navigateBack);

/* Back buttons for new screens */
document.getElementById('pickerBackBtn').addEventListener('click', navigateBack);
document.getElementById('detailsBackBtn').addEventListener('click', navigateBack);

/* ---------- Add from Picker (Screen 2 button) ---------- */
function promptAddFromPicker(i,j){
  const data = JOURNEYS[i].items[j];
  openDateModal({source:'picker', name:data.name});
}

/* ---------- Main card list management ---------- */
const selectedJourneys = []; // {name, est}

function addJourneyToCard(name, estDate){
  selectedJourneys.push({name, est: estDate || ''});
  renderJourneyList();
}

function renderJourneyList(){
  const list = document.getElementById('journeyList');
  const placeholder = document.getElementById('journeyPlaceholder');

  if(selectedJourneys.length === 0){
    list.style.display = 'none';
    placeholder.style.display = '';
    return;
  }

  placeholder.style.display = 'none';

  list.style.display = 'block';
  list.innerHTML = selectedJourneys.map(j=>{
    return `<li><span>${j.name}</span><button class="secondary-btn mini-btn view-btn" data-name="${j.name}">View Journey</button></li>`;
  }).join('');
}

/* Attach handler for dynamic "View Journey" buttons */
document.getElementById('journeyList').addEventListener('click', (e)=>{
  const btn = e.target.closest('.view-btn');
  if(!btn) return;
  const jname = btn.getAttribute('data-name');
  openWorkspace(jname);
});

/* ---------- Old overlay detail helpers (preserved; not used now) ---------- */
function toggleCategory(i){
  if(currentOpen !== null && currentOpen !== i){
    setOpen(currentOpen, false);
  }
  const willOpen = currentOpen !== i;
  setOpen(i, willOpen);
  currentOpen = willOpen ? i : null;
  if(willOpen && currentDetail && currentDetail.i !== i){
    removeDetail();
  }
}
function setOpen(i, open){
  const acc = document.querySelector(`.acc[data-idx="${i}"]`);
  if(!acc) return;
  acc.classList.toggle('open', open);
}
function revealJourney(i,j,evt){
  if(currentDetail && currentDetail.i===i && currentDetail.j===j){
    removeDetail(); return;
  }
  removeDetail();

  const acc = document.querySelector(`.acc[data-idx="${i}"]`);
  const panel = acc.querySelector('.acc-panel');
  const items = panel.querySelectorAll('.jitem');
  const anchor = items[j];

  const data = JOURNEYS[i].items[j];
  const detail = document.createElement('div');
  detail.className = 'jdetail';
  detail.innerHTML = `
    <div class="h">${data.name}</div>
    <div class="p"><strong>Best For:</strong> ${data.bestFor}</div>
    <div class="p"><strong>Ideal Contacts:</strong> ${data.ideal}</div>
    <div class="p"><strong>Goal:</strong> ${data.goal}</div>
    <button class="add-btn" onclick="addJourney('${data.name.replace(/'/g,"\\'")}')">Add to Journey</button>
  `;
  anchor.insertAdjacentElement('afterend', detail);
  currentDetail = {i,j,el:detail};

  setTimeout(() => {
    detail.scrollIntoView({behavior:'smooth', block:'end'});
  }, 0);
}
function removeDetail(){
  if(currentDetail && currentDetail.el){
    currentDetail.el.remove();
  }
  currentDetail = null;
}
function addJourney(name){
  closeSheet('journeyOverlay');
  flashToast(`Added “${name}” to this contact.`);
}

/* improved toast (more visible) */
let toastTimer;
function flashToast(text){
  let t = document.getElementById('seg-toast');
  if(!t){
    t = document.createElement('div');
    t.id = 'seg-toast';
    t.style.position='absolute';
    t.style.top='calc(var(--status-h) + 10px)';
    t.style.left='50%';
    t.style.transform='translateX(-50%) translateY(-120%)';
    t.style.background='#0B1F3F';
    t.style.color='#fff';
    t.style.padding='10px 16px';
    t.style.borderRadius='12px';
    t.style.fontSize='13px';
    t.style.fontWeight='800';
    t.style.boxShadow='0 10px 24px rgba(0,0,0,.22)';
    t.style.transition='transform .25s ease, opacity .25s ease';
    t.style.opacity='0';
    t.style.zIndex='1000';
    document.querySelector('.phone').appendChild(t);
  }
  t.textContent = text;
  t.style.opacity='1';
  t.style.transform='translateX(-50%) translateY(0)';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{
    t.style.opacity='0';
    t.style.transform='translateX(-50%) translateY(-120%)';
  }, 2000);
}

/* ---------- NEW: Date Modal logic ---------- */
let dateModalContext = null; // {source:'picker'|'details', name:string}

function openDateModal(ctx){
  dateModalContext = ctx || null;
  const modal = document.getElementById('dateModal');
  const input = document.getElementById('dateInput');
  const dt = new Date();
  dt.setDate(dt.getDate()+14);
  input.value = dt.toISOString().slice(0,10);
  modal.classList.add('show');
}

function closeDateModal(shouldAdd, dateValue){
  const modal = document.getElementById('dateModal');
  modal.classList.remove('show');

  if(shouldAdd && dateModalContext){
    addJourneyToCard(dateModalContext.name, dateValue || '');
    flashToast(`Added “${dateModalContext.name}” to this contact.`);
    if(navStack[navStack.length-1] === 'screen-details'){
      navigateBack();
      setTimeout(()=>navigateBack(), 30);
    } else if(navStack[navStack.length-1] === 'screen-picker'){
      navigateBack();
    }
  }
  dateModalContext = null;
}

document.getElementById('dateNotNow').addEventListener('click', ()=>{ closeDateModal(true, ''); });
document.getElementById('dateContinue').addEventListener('click', ()=>{
  const val = document.getElementById('dateInput').value || '';
  closeDateModal(true, val);
});

/* ---------- NEW: Journey Workspace Data + Logic ---------- */

/* Phase/task definitions per journey */
const JOURNEY_MAP = {
  'Event High-Value Sales Meeting Journey': [
    { title:'Automated Priority Outreach', tasks:[] },
    { title:'Manual Direct Outreach', tasks:[{title:'Personalized high-touch message/call'}] },
    { title:'Scheduling', tasks:[] },
    { title:'High-Value Session', tasks:[] }
  ],
  'Event Warm Reconnect Journey': [
    { title:'Automated Messaging Outreach', tasks:[] },
    { title:'Manual Personal Outreach', tasks:[{title:'Casual follow-up note or call'}] },
    { title:'Time Coordination', tasks:[] },
    { title:'Follow-Up Meeting', tasks:[] }
  ],
  'Event Dormant Reconnect Journey': [
    { title:'Automated Reconnect Outreach', tasks:[] },
    { title:'Manual Memory Outreach', tasks:[{title:'Personal reminder of past contact'}] },
    { title:'Calendar Setup', tasks:[] },
    { title:'Reconnection Meeting', tasks:[] }
  ],
  'Event New Contact Follow-Up Journey': [
    { title:'Automated Event Outreach', tasks:[] },
    { title:'Manual Context Outreach', tasks:[{title:'Manual message referencing event conversation'}] },
    { title:'Scheduling Coordination', tasks:[] },
    { title:'Networking Session', tasks:[] }
  ],
  'Event Acknowledgment Journey': [
    { title:'Automated Appreciation Outreach', tasks:[] },
    { title:'Manual 30-Day Check-In', tasks:[] }
  ],
  'Event Urgent Demo Journey': [
    { title:'Automated Rapid Outreach', tasks:[] },
    { title:'Manual Urgency Outreach', tasks:[{title:'Confirm urgency with quick manual touchpoint'}] },
    { title:'Demo Scheduling', tasks:[] },
    { title:'Demo Session', tasks:[] }
  ],
  'Cold/General Meeting Request Journey': [
    { title:'Automated Introductory Outreach', tasks:[] },
    { title:'Manual Engagement Outreach', tasks:[{title:'Light manual follow-up (call, DM)'}] },
    { title:'Appointment Setting', tasks:[] },
    { title:'Discovery Session', tasks:[] }
  ],
  'Business Card Reactivate Journey': [
    { title:'Automated Reactivation Outreach', tasks:[] },
    { title:'Manual Follow-Up Outreach', tasks:[{title:'Personalized message or call to reintroduce yourself'}] },
    { title:'Scheduling a Time', tasks:[] },
    { title:'Reconnection Session', tasks:[] }
  ]
};

/* runtime workspace state per journey */
const workspaceState = {}; // { [journeyName]: { phases: [ {status, startedAt, tasks:[{status}] } ] } }

function initWorkspaceState(name){
  if(workspaceState[name]) return;
  const base = JOURNEY_MAP[name] || [];
  const phases = base.map(p=>({
    title:p.title,
    status:'Not Begun',
    startedAt:null,
    tasks:(p.tasks||[]).map(t=>({title:t.title, status:'Not Begun'}))
  }));
  // 1) First phase always Started; others Not Begun
  if(phases.length){
    phases[0].status = 'Started';
    phases[0].startedAt = new Date().toISOString().slice(0,10);
  }
  workspaceState[name] = { phases };
}

/* Build the workspace UI */
function openWorkspace(journeyName){
  initWorkspaceState(journeyName);
  document.getElementById('wsTitle').textContent = journeyName;
  buildWorkspaceList(journeyName);
  navigateTo('screen-workspace');
}

document.getElementById('wsBackBtn').addEventListener('click', navigateBack);

/* Render phases with accordion behavior */
let wsOpenIdx = null;

function buildWorkspaceList(journeyName){
  const wrap = document.getElementById('wsPhases');
  const empty = document.getElementById('wsEmpty');
  const data = workspaceState[journeyName];
  if(!data || !data.phases.length){
    empty.style.display='block';
    wrap.innerHTML='';
    return;
  }
  empty.style.display='none';

  // default open: first not Completed
  const firstNotCompleted = data.phases.findIndex(p=>p.status!=='Completed');
  wsOpenIdx = firstNotCompleted >= 0 ? firstNotCompleted : 0;

  wrap.innerHTML = data.phases.map((p,idx)=>{
    const isOpen = idx===wsOpenIdx;
    const statusLine = p.status==='Started'
      ? `Status: Started • Started: ${p.startedAt || new Date().toISOString().slice(0,10)}`
      : `Status: ${p.status}`;
    const right = p.status==='Started'
      ? `<button class="phase-complete" data-idx="${idx}" data-act="completePhase">Complete Phase</button>`
      : `<span class="pill">${p.status || 'Not Begun'}</span>`;
    const tasksHTML = p.tasks.length
      ? p.tasks.map((t,tidx)=>`
          <div class="task" data-phase="${idx}" data-task="${tidx}">
            <div class="t-left">
              <div class="t-title">${t.title}</div>
              <div class="t-meta">Status: ${t.status}</div>
            </div>
            <div class="t-actions">
              ${t.status!=='Completed' ? `<button class="btn-start" data-act="startTask">Start</button>` : ''}
              <div class="kebab" data-act="menu"></div>
            </div>
          </div>
        `).join('')
      : `<div style="padding:12px;color:#667085;font-size:12px;border-top:1px solid #eef2f7">No tasks in this phase.</div>`;

    return `
      <div class="phase ${isOpen?'open':''}" data-idx="${idx}">
        <div class="phase-head" data-act="toggle">
          <div>
            <div class="phase-title">${p.title}</div>
            <div class="phase-meta">${statusLine}</div>
          </div>
          <div class="phase-actions">${right}</div>
        </div>
        <div class="phase-panel"${isOpen?' style="max-height:9999px; padding-bottom:4px"':''}>
          ${tasksHTML}
        </div>
      </div>
    `;
  }).join('');

  requestAnimationFrame(()=>{
    const open = wrap.querySelector('.phase.open .phase-panel');
    if(open){
      open.style.maxHeight = open.scrollHeight+'px';
    }
  });
}

/* Accordion toggle (single open) + complete phase */
document.getElementById('wsPhases').addEventListener('click', (e)=>{
  const head = e.target.closest('.phase-head');
  const completeBtn = e.target.closest('[data-act="completePhase"]');
  const container = document.getElementById('wsPhases');
  const journeyName = document.getElementById('wsTitle').textContent;
  const state = workspaceState[journeyName];

  if(completeBtn){
    const idx = parseInt(completeBtn.getAttribute('data-idx'),10);
    state.phases[idx].status = 'Completed';
    if(state.phases[idx+1]){
      state.phases[idx+1].status = 'Started';
      state.phases[idx+1].startedAt = new Date().toISOString().slice(0,10);
      wsOpenIdx = idx+1;
    }else{
      wsOpenIdx = idx;
    }
    buildWorkspaceList(journeyName);
    flashToast(`Phase ${idx+1} completed.`);
    return;
  }

  if(head){
    const phaseEl = head.closest('.phase');
    const idx = parseInt(phaseEl.getAttribute('data-idx'),10);

    const currentlyOpen = container.querySelector('.phase.open');
    if(currentlyOpen && currentlyOpen !== phaseEl){
      const p1 = currentlyOpen.querySelector('.phase-panel');
      if(getComputedStyle(p1).maxHeight === 'none'){
        p1.style.maxHeight = p1.scrollHeight+'px';
      }
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        p1.style.maxHeight = '0px';
      }));
      currentlyOpen.classList.remove('open');
    }

    const panel = phaseEl.querySelector('.phase-panel');
    const isOpen = phaseEl.classList.contains('open');
    if(isOpen){
      if(getComputedStyle(panel).maxHeight === 'none'){
        panel.style.maxHeight = panel.scrollHeight+'px';
      }
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        panel.style.maxHeight = '0px';
      }));
      phaseEl.classList.remove('open');
      wsOpenIdx = null;
    }else{
      phaseEl.classList.add('open');
      panel.style.maxHeight = panel.scrollHeight+'px';
      wsOpenIdx = idx;

      // keep: opening a Not Begun phase marks it Started
      const ph = state.phases[idx];
      if(ph.status === 'Not Begun'){
        ph.status = 'Started';
        ph.startedAt = new Date().toISOString().slice(0,10);
        const meta = phaseEl.querySelector('.phase-meta');
        meta.textContent = `Status: Started • Started: ${ph.startedAt}`;
        const actions = phaseEl.querySelector('.phase-actions');
        actions.innerHTML = `<button class="phase-complete" data-idx="${idx}" data-act="completePhase">Complete Phase</button>`;
      }
    }
  }
});

/* ---------- Task Actions ---------- */
let activeTaskRef = null; // {phaseIdx, taskIdx, journey}

const kebabMenu = document.getElementById('kebabMenu');

document.getElementById('wsPhases').addEventListener('click', (e)=>{
  const startBtn = e.target.closest('[data-act="startTask"]');
  const kebab = e.target.closest('[data-act="menu"]');
  const taskRow = e.target.closest('.task');
  if(!taskRow) return;

  const phaseIdx = parseInt(taskRow.getAttribute('data-phase'),10);
  const taskIdx = parseInt(taskRow.getAttribute('data-task'),10);
  const journey = document.getElementById('wsTitle').textContent;

  if(startBtn){
    activeTaskRef = {phaseIdx, taskIdx, journey};
    openTaskModal(journey, phaseIdx, taskIdx);
    return;
  }

  if(kebab){
    activeTaskRef = {phaseIdx, taskIdx, journey};
    // position menu near kebab and keep within phone bounds
    const phone = document.querySelector('.phone');
    const phoneRect = phone.getBoundingClientRect();
    const rect = kebab.getBoundingClientRect();

    // initial placement below and slightly left
    let left = rect.left - phoneRect.left - 6;
    let top = rect.bottom - phoneRect.top + 6;

    kebabMenu.style.left = left + 'px';
    kebabMenu.style.top = top + 'px';
    kebabMenu.classList.add('show');

    // after shown, clamp within phone
    requestAnimationFrame(()=>{
      const mRect = kebabMenu.getBoundingClientRect();
      const pad = 6;
      const maxLeft = phoneRect.width - mRect.width - pad;
      const maxTop = phoneRect.height - mRect.height - pad;

      if(left > maxLeft) left = Math.max(pad, maxLeft);
      if(top > maxTop){
        // flip above the kebab
        top = rect.top - phoneRect.top - mRect.height - pad;
        if(top < pad) top = pad;
      }
      if(left < pad) left = pad;

      kebabMenu.style.left = left + 'px';
      kebabMenu.style.top = top + 'px';
    });
    return;
  }
});

document.addEventListener('click', (e)=>{
  if(!e.target.closest('.kebab-menu') && !e.target.closest('.kebab')){
    kebabMenu.classList.remove('show');
  }
});

kebabMenu.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if(!btn || !activeTaskRef) return;
  const act = btn.getAttribute('data-act');
  const {journey, phaseIdx, taskIdx} = activeTaskRef;
  const t = workspaceState[journey].phases[phaseIdx].tasks[taskIdx];

  if(act==='start') t.status = 'Started';
  if(act==='complete') t.status = 'Completed';
  if(act==='queue') t.status = 'Queued';
  if(act==='cancel') t.status = 'Cancelled';
  if(act==='pause') t.status = 'Paused';
  // 'assign' no-op placeholder

  buildWorkspaceList(journey);
  kebabMenu.classList.remove('show');
  activeTaskRef = null;
});

/* Smart Task modal (Compose Email) */
function openTaskModal(journey, phaseIdx, taskIdx){
  const modal = document.getElementById('taskModal');
  const title = document.getElementById('taskModalTitle');
  const t = workspaceState[journey].phases[phaseIdx].tasks[taskIdx];
  title.textContent = `Compose Email — ${t.title}`;
  document.getElementById('taskNotes').value = '';
  modal.classList.add('show');
}
function closeTaskModal(){
  document.getElementById('taskModal').classList.remove('show');
}

document.getElementById('taskCancelBtn').addEventListener('click', ()=>{
  closeTaskModal();
  activeTaskRef = null;
});
document.getElementById('taskSendBtn').addEventListener('click', ()=>{
  if(!activeTaskRef) return closeTaskModal();
  const {journey, phaseIdx, taskIdx} = activeTaskRef;
  const t = workspaceState[journey].phases[phaseIdx].tasks[taskIdx];
  // Simulate sending email: set to Started and toast
  if(t.status==='Not Begun') t.status='Started';
  buildWorkspaceList(journey);
  closeTaskModal();
  flashToast('Email sent.');
  activeTaskRef = null;
});

/* open the picker (wired from main screen link) */
document.getElementById('addJourneyLink').addEventListener('click', openJourneyPicker);

// initialize header visibility on load
updateHeaderVisibility();
</script>
</body>
</html>
