<!DOCTYPE html>  
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Segwik AI â€“ Contact Details</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --ink:#243048; --muted:#667085; --line:#e6ebf2;
    --accent:#0F2D56; --btn:#1d305e; --pill:#eef4ff; --pill-border:#cfe1ff;
    --phone-w:430px; --phone-h:800px; --footer-h:76px; --status-h:46px; --head-h:52px;

    /* NEW animation tuning */
    --slide-dur:.36s;
    --slide-ease:cubic-bezier(.22,.61,.36,1);
    --acc-dur:.28s;
    --acc-ease:cubic-bezier(.25,.8,.25,1);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);
    font-family:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,'Helvetica Neue',Arial,sans-serif}
  .wrap{display:flex;align-items:center;justify-content:center;min-height:100%;padding:18px}

  .phone{width:var(--phone-w);height:var(--phone-h);background:#fff;border-radius:36px;
    box-shadow:0 20px 60px rgba(0,0,0,.12),0 8px 16px rgba(0,0,0,.08);position:relative;
    overflow:hidden;border:8px solid #111;display:flex;flex-direction:column}
  .notch{position:absolute;top:8px;left:50%;transform:translateX(-50%);width:180px;height:30px;background:#111;border-radius:20px 20px 28px 28px;z-index:10}

  .status{height:var(--status-h);padding:0 16px;display:flex;align-items:center;justify-content:center;gap:8px;border-bottom:1px solid var(--line);background:#fff;z-index:5}
  .status .logo{display:flex;align-items:center;gap:8px;font-weight:700;letter-spacing:.3px}
  .status .logo .bot{width:22px;height:22px;border-radius:50%;background:linear-gradient(145deg,#e9f0ff,#dfe9ff);display:grid;place-items:center;border:1px solid #c9d7ff}
  .status .logo .bot::before{content:"";width:10px;height:6px;border-radius:3px;display:block;background:#0F2D56;box-shadow:0 0 0 2px #b7ccff inset}

  .page-head{position:sticky; top:0; z-index:4; background:#fff; border-bottom:1px solid var(--line)}
  .page-head.hidden{display:none}
  .page-title{height:var(--head-h); padding:12px 16px 8px; display:flex; align-items:center; justify-content:space-between}
  .left-row{display:flex;align-items:center;gap:10px}
  .back{width:32px;height:32px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;display:grid;place-items:center;cursor:pointer}
  .back svg{width:18px;height:18px}
  .title-text{font-weight:800;color:var(--accent);font-size:18px}

  .content{flex:1; overflow:auto; background:#f6f8fb; padding-bottom:var(--footer-h);}

  .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px}
  .card-head{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .card-head .emoji{font-size:20px}
  .card-title{font-weight:800;font-size:16px}
  .card-body{font-size:13px;color:var(--muted);line-height:1.5;margin-bottom:10px}
  .action-center{display:flex;justify-content:center}
  .action-text{font-weight:700;color:#0F2D56;cursor:pointer;text-align:center;font-size:13px}

  .tray{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:8px;border-top:1px solid var(--line);background:#fff;position:sticky;bottom:0}
  .ibtn{padding:8px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;display:grid;place-items:center;font-size:11px;cursor:pointer}
  .ibtn svg{width:17px;height:17px}
  svg{stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

  /* ---------- Journey Picker (bottom sheet INSIDE phone) ---------- */
  .overlay{position:absolute;inset:0;background:rgba(15,45,86,.28);display:none;align-items:flex-end;z-index:50}
  .overlay.show{display:flex}
  .sheet{width:100%;max-height:72%;background:#fff;border-top:1px solid var(--pill-border);
    border-radius:18px 18px 0 0;box-shadow:0 18px 40px rgba(15,45,86,.18);
    padding:14px 14px 10px;transform:translateY(100%);transition:transform .25s ease}
  .overlay.show .sheet{transform:translateY(0)}
  .sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .sheet-title{font-weight:800;color:#0F2D56}
  .x{width:28px;height:28px;border-radius:8px;border:1px solid #e4ecff;background:#eef4ff;display:grid;place-items:center;cursor:pointer}
  .x:hover{filter:brightness(.96)}
  /* more bottom padding so the last button never clips */
  #journeyBody{overflow:auto; padding-bottom:80px}

  /* Accordion categories */
  .acc{border:1px solid #e6ebf2;border-radius:12px;background:#fff;margin-bottom:10px;overflow:hidden}
  .acc-head{display:flex;align-items:center;justify-content:space-between;padding:12px 12px;cursor:pointer}
  .acc-title{font-weight:800;color:#243048;font-size:14px}
  .acc-head svg{width:18px;height:18px;transition:transform var(--acc-dur) var(--acc-ease);opacity:.8}
  .acc.open .acc-head svg{transform:rotate(90deg)}
  .acc-panel{
    overflow:hidden;
    max-height:0;
    transition:max-height var(--acc-dur) var(--acc-ease), padding var(--acc-dur) var(--acc-ease);
    will-change:max-height;
  }
  .acc.open .acc-panel{ /* keep for fallback; JS sets exact max-height for buttery anims */
    /* max-height is set inline for smooth animation */
  }

  /* Journey item list */
  .jitem{display:flex;align-items:center;justify-content:space-between;padding:12px;border-top:1px solid #eef2f7;cursor:pointer;gap:8px}
  .jitem .name{font-size:13px;color:#243048;flex:1;min-width:0}
  .jitem svg{width:16px;height:16px;opacity:.6}

  /* Journey detail reveal (used in old overlay; kept intact) */
  .jdetail{background:#f8fbff;border-top:1px dashed #dbe7ff;padding:10px 12px;line-height:1.4}
  .jdetail .h{font-weight:800;color:#0F2D56;margin-bottom:6px}
  .jdetail .p{font-size:12px;color:#475569;margin:4px 0}
  .add-btn{margin-top:10px;display:inline-block;background:#1d305e;color:#fff;border:1px solid #1d305e;border-radius:10px;padding:8px 12px;font-size:12px;cursor:pointer}
  .add-btn.small{margin-top:0;padding:6px 10px;font-size:12px;border-radius:8px;flex:0 0 120px;text-align:center} /* fixed width for uniform size */

  /* ---------- NEW: In-app screen navigation (slide in/out) ---------- */
  .screens{position:relative;flex:1;overflow:hidden;background:#f6f8fb}
  .screen{
    position:absolute; inset:0; display:flex; flex-direction:column; background:#f6f8fb;
    transform:translateX(0); opacity:1; pointer-events:auto;
    transition:transform var(--slide-dur) var(--slide-ease), opacity var(--slide-dur) ease-out;
    will-change:transform, opacity;
  }
  .screen.hidden{opacity:0; pointer-events:none}
  .screen.off-right{transform:translateX(100%); opacity:0; pointer-events:none}
  .screen.off-left{transform:translateX(-10%); opacity:.0; pointer-events:none}

  /* Picker screen specific */
  .picker-head{position:sticky; top:0; z-index:4; background:#fff; border-bottom:1px solid var(--line)}
  .picker-title{height:var(--head-h); padding:12px 16px 8px; display:flex; align-items:center; justify-content:space-between}
  .search-wrap{padding:10px 12px;background:#fff;border-bottom:1px solid var(--line)}
  .search-wrap input{
    width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:14px; outline:none;
    background:#f8fafc;
  }
  .search-note{color:#858ca0;font-size:12px;margin:8px 12px 0} /* NEW: gray note */

  .picker-content{flex:1; overflow:auto; background:#f6f8fb; padding-bottom:var(--footer-h);}

  /* Details screen */
  .details-body{padding:12px; flex:1; overflow:auto; scroll-behavior:smooth;} /* scroll smoothly */
  .details-card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0}
  .details-card .h{font-weight:800;color:#0F2D56;margin-bottom:8px}
  .details-card .p{font-size:13px;color:#475569;margin:6px 0;line-height:1.5}
  .details-actions{display:flex;gap:10px; padding:8px 12px}
  .primary-btn{background:#1d305e;color:#fff;border:1px solid #1d305e;border-radius:12px;padding:10px 14px;font-size:13px;cursor:pointer}
  .secondary-btn{background:#fff;color:#0F2D56;border:1px solid var(--line);border-radius:12px;padding:10px 14px;font-size:13px;cursor:pointer}
  .mini-btn{padding:6px 10px;font-size:12px;border-radius:8px}
  .milestone-row{display:flex;flex-direction:column;gap:6px;padding:10px 0;border-top:1px dashed #e7eefb}
  .milestone-row:first-child{border-top:0;padding-top:0}
  .milestone-title{font-weight:700;color:#243048}
  .milestone-input{display:flex;align-items:center;gap:10px}
  .milestone-input input[type="date"]{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;font-size:13px}

  /* Obvious snap highlight */
  @keyframes snapPulse{
    0%{box-shadow:0 0 0 0 rgba(15,45,86,0); background:#fff;}
    20%{box-shadow:0 0 0 6px rgba(15,45,86,.12); background:#fffef3;}
    60%{box-shadow:0 0 0 0 rgba(15,45,86,0); background:#fff;}
    100%{box-shadow:0 0 0 0 rgba(15,45,86,0); background:#fff;}
  }
  .snap-highlight{animation:snapPulse 900ms ease-out;}

  /* Small inline list for selected journeys on main screen */
  .journey-list{list-style:none;margin:8px 0 0;padding:0}
  .journey-list li{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#f8fbff;margin-top:8px;font-size:13px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .journey-list .date{font-size:12px;color:#667085}
  .journey-pill{padding:4px 8px;border-radius:999px;border:1px solid var(--pill-border);background:var(--pill);font-weight:700;font-size:11px;color:#0F2D56}
  .journey-list .view-btn{flex:0 0 120px;text-align:center} /* NEW: fixed width 'View Journey' */

  /* ---------- NEW: Date Modal ---------- */
  /* (removed per request) */

  /* ======= NEW: Journey Workspace (phases/tasks) ======= */
  /* workspace screen uses 280ms ease-in-out without touching others */
  .screen.workspace{
    transition:transform .28s ease-in-out, opacity .28s ease-in-out;
  }
  .phase-card{background:#fff;border:1px solid var(--line);border-radius:14px;margin:10px 12px;overflow:hidden}
  .phase-head{display:flex;align-items:center;justify-content:space-between;padding:12px;cursor:pointer;gap:10px}
  .phase-title{font-weight:800}
  .phase-meta{font-size:12px;color:var(--muted)}
  .phase-right{display:flex;align-items:center;gap:8px}
  .phase-pill{padding:4px 8px;border-radius:999px;border:1px solid var(--pill-border);background:var(--pill);
    font-weight:700;font-size:11px;color:#0F2D56}
  .phase-complete-btn{background:#1d305e;color:#fff;border:1px solid #1d305e;border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}

  .phase-panel{max-height:0;overflow:hidden;transition:max-height .28s ease, padding .28s ease; padding:0 12px}
  .phase-panel.open{padding:12px}

  .task{border-top:1px dashed #e7eefb;padding:10px 0;font-size:13px;color:#475569;display:flex;justify-content:space-between;align-items:center;gap:10px}
  .task .left .title{font-weight:800;color:#243048}
  .task .left .status{font-size:12px;color:#667085;margin-top:4px}
  .task .right{display:flex;align-items:center;gap:8px}
  .task .start-btn{background:#fff;color:#0F2D56;border:1px solid var(--line);border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
  .task .menu-btn{width:28px;height:28px;border:1px solid var(--line);border-radius:8px;background:#f8fafc;display:grid;place-items:center;cursor:pointer}
  .kebab{width:16px;height:16px;display:block;position:relative}
  .kebab::before{content:"";display:block;width:3px;height:3px;background:#243048;border-radius:50%;box-shadow:0 6px 0 #243048,0 -6px 0 #243048}

  /* contextual menu */
  .menu-pop{position:absolute;z-index:80;background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 14px 28px rgba(0,0,0,.12);overflow:hidden}
  .menu-pop button{display:block;width:200px;text-align:left;background:#fff;border:0;border-bottom:1px solid #f0f3f8;padding:10px 12px;font-size:13px;color:#243048;cursor:pointer}
  .menu-pop button:last-child{border-bottom:0}
  .menu-pop button:hover{background:#f6f9ff}

  /* Smart Task modal (bottom sheet) */
  .task-overlay{position:absolute;inset:0;background:rgba(15,45,86,.28);display:none;align-items:flex-end;z-index:90}
  .task-overlay.show{display:flex}
  .task-sheet{width:100%;max-height:70%;background:#fff;border-top:1px solid var(--pill-border);border-radius:18px 18px 0 0;
    box-shadow:0 18px 40px rgba(15,45,86,.18);transform:translateY(100%);transition:transform .25s ease}
  .task-overlay.show .task-sheet{transform:translateY(0)}
  .task-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
  .task-title{font-weight:800;color:#0F2D56}
  .task-body{padding:12px 14px}
  .task-body textarea{width:100%;min-height:120px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;font-family:inherit;font-size:13px}
  .task-actions{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px 16px;border-top:1px solid #f0f3f8}
</style>
</head>
<body>
<div class="wrap">
  <div class="phone">
    <div class="notch"></div>
    <div class="status">
      <div class="logo"><span class="bot"></span><span>SEGWiK</span></div>
    </div>

    <!-- ORIGINAL MAIN PAGE HEADER -->
    <div class="page-head" id="mainHeader">
      <div class="page-title">
        <div class="left-row">
          <div class="back" onclick="history.back()">
            <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
          </div>
          <div class="title-text">Contact Details</div>
        </div>
      </div>
    </div>

    <!-- NEW: SCREEN STACK -->
    <div class="screens" id="screenStack">
      <!-- Screen 1: Main Contact Details -->
      <div class="screen" id="screen-main">
        <div class="content">




          <section class="card" id="journeyCard">
            <div class="card-head"><span class="emoji">ðŸ“ˆ</span><div class="card-title">Journey Status</div></div>
            <div class="card-body" id="journeyCardBody">
              <div id="journeyPlaceholder">This contact doesn't have any journeys. Want to add any journeys?</div>
              <ul class="journey-list" id="journeyList" style="display:none;"></ul>
            </div>
            <div class="action-center">
              <div class="action-text" id="addJourneyLink">+ Add Journey</div>
            </div>
          </section>

   
        </div>
      </div>

      <!-- Screen 2: Journey Picker (search + categories + direct Add) -->
      <div class="screen off-right hidden" id="screen-picker" aria-hidden="true">
        <div class="picker-head">
          <div class="picker-title">
            <div class="left-row">
              <div class="back" id="pickerBackBtn">
                <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
              </div>
              <div class="title-text">Add Journey</div>
            </div>
          </div>
          <div class="search-wrap">
            <input type="search" id="journeySearch" placeholder="Search journeys or categories..." />
            <div class="search-note">Tip: Click a journey to view more details.</div>
          </div>
        </div>
        <div class="picker-content">
          <div id="pickerAccordion" style="padding:12px"></div>
        </div>
      </div>

      <!-- Screen 3: Journey Details full screen -->
      <div class="screen off-right hidden" id="screen-details" aria-hidden="true">
        <div class="picker-head">
          <div class="picker-title">
            <div class="left-row">
              <div class="back" id="detailsBackBtn">
                <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
              </div>
              <div class="title-text" id="detailsTitle">Journey Details</div>
            </div>
          </div>
        </div>
        <div class="details-body">
          <div class="details-card">
            <div class="h" id="detailsName">Journey Name</div>
            <div class="p"><strong>Best For:</strong> <span id="detailsBestFor"></span></div>
            <div class="p"><strong>Ideal Contacts:</strong> <span id="detailsIdeal"></span></div>
            <div class="p"><strong>Goal:</strong> <span id="detailsGoal"></span></div>
          </div>

          <!-- NEW: Milestones section -->
          <div class="details-card" id="milestonesSection">
            <div class="h">Milestones</div>
            <div id="milestonesList"></div>
          </div>

          <!-- NEW: Journey Estimated Completion Date field -->
          <div class="details-card">
            <div class="h">Estimated Journey Completion Date</div>
            <input type="date" id="journeyEstInput" />
          </div>

          <div class="details-actions">
            <button class="primary-btn" id="detailsAddBtn">Add to Journey</button>
            <button class="secondary-btn" id="detailsCancelBtn">Cancel</button>
          </div>
        </div>
      </div>

      <!-- ===== Screen 4: Journey Workspace ===== -->
      <div class="screen off-right hidden workspace" id="screen-workspace" aria-hidden="true">
        <div class="picker-head">
          <div class="picker-title">
            <div class="left-row">
              <div class="back" id="workspaceBackBtn">
                <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
              </div>
              <div class="title-text" id="workspaceTitle">Journey</div>
            </div>
          </div>
        </div>
        <div class="content" id="workspaceBody" style="padding-bottom:96px;">
          <!-- phases render here -->
        </div>
      </div>
      <!-- /Screen 4 -->

    </div>
    <!-- /NEW: SCREEN STACK -->

    <div class="tray" id="footer-tray">
      <div class="ibtn" data-icon="phone"></div>
      <div class="ibtn" data-icon="mail"></div>
      <div class="ibtn" data-icon="chat"></div>
      <div class="ibtn" data-icon="calendar"></div>
      <div class="ibtn" data-icon="note"></div>
    </div>

    <!-- Journey Picker Overlay (inside phone) -->
    <div id="journeyOverlay" class="overlay" onclick="overlayClose(event,'journeyOverlay')" role="dialog" aria-modal="true">
      <div class="sheet" onclick="event.stopPropagation()">
        <div class="sheet-head">
          <div class="sheet-title">Add Journey</div>
          <div class="x" onclick="closeSheet('journeyOverlay')">Ã—</div>
        </div>
        <div id="journeyBody"></div>
      </div>
    </div>
    <!-- /Journey Picker Overlay -->

    <!-- NEW: Centered Date Modal -->
    <!-- (removed per request) -->

    <!-- Smart Task bottom sheet -->
    <div id="taskModal" class="task-overlay" onclick="if(event.target.id==='taskModal'){closeTaskModal()}">
      <div class="task-sheet" onclick="event.stopPropagation()">
        <div class="task-head">
          <div class="task-title" id="taskModalTitle">Task</div>
          <div class="x" onclick="closeTaskModal()">Ã—</div>
        </div>
        <div class="task-body">
          <div id="taskModalMeta" class="dialog-body" style="margin:0 0 10px;"></div>
          <textarea id="taskNotes" placeholder="Notes, message body, or call outcomeâ€¦"></textarea>
        </div>
        <div class="task-actions">
          <button class="secondary-btn" id="taskSave">Save</button>
          <button class="primary-btn" id="taskComplete">Complete Task</button>
        </div>
      </div>
    </div>
    <!-- /Smart Task bottom sheet -->

  </div>
</div>

<script>
/* footer icons (same set) */
function icon(name){
  switch(name){
    case 'mail': return `<svg viewBox="0 0 24 24"><path d="M4 6h16v12H4z"/><path d="M4 7l8 6 8-6"/></svg>`;
    case 'phone': return `<svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0  0 1-6-6 19.79 19.79 0  0 1-3.07-8.67A2 2 0  0 1 4.11 2h3a2 2 0  0 1 2 1.72c.12 .9.3 1.77.57 2.61a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0  0 0 6 6l1.47-1.11a2 2 0 0 1 2.11-.45c.84 .27 1.71 .45 2.61 .57A2 2 0  0 1 22 16.92z"/></svg>`;
    case 'chat': return `<svg viewBox="0 0 24 24"><path d="M21 15a4 4 0  0 1-4 4H8l-5 3V7a4 4 0  0 1 4-4h10a4 4 0  0 1 4 4z"/></svg>`;
    case 'calendar': return `<svg viewBox="0 0 24 24"><path d="M3 8h18M5 4h14v16H5z"/><path d="M16 2v4M8 2v4"/></svg>`;
    case 'note': return `<svg viewBox="0 0 24 24"><path d="M4 3h14l2 2v16H4z"/><path d="M9 13h6M9 9h6M9 17h3"/></svg>`;
  }
}
document.querySelectorAll('#footer-tray [data-icon]').forEach(el=>{
  el.innerHTML = icon(el.getAttribute('data-icon')) || '';
});

/* ---------- Journey data with descriptions ---------- */
const JOURNEYS = [
  {
    cat: 'Contact Reactivation',
    items: [
      {
        name: 'Cold/General Meeting Request Journey',
        bestFor: 'When interest is unclear or low, but you still want to test engagement.',
        ideal: 'New contacts, casual networking connections, or unqualified leads.',
        goal: 'Test interest and gauge engagement to decide if further conversations are worthwhile.'
      },
      {
        name: 'Business Card Reactivate Journey',
        bestFor: 'Reaching out to old, very old, or unknown contacts you are rediscovering.',
        ideal: 'Names from a stack of business cards, outdated lists, or long-idle phone entries.',
        goal: 'Lightly reintroduce yourself, acknowledge the time gap, and reopen the door.'
      }
    ]
  },
  {
    cat: 'Event Follow-ups',
    items: [
      {
        name: 'Event High-Value Sales Meeting Journey',
        bestFor: 'Securing a decision-making meeting quickly after meeting a highly qualified contact.',
        ideal: 'Senior decision-makers, high-value prospects, or warm referrals met at an event.',
        goal: 'Secure a sales/decision meeting ASAP with a top-priority contact.'
      },
      {
        name: 'Event Warm Reconnect Journey',
        bestFor: 'Following up after reconnecting with someone you already know at an event.',
        ideal: 'Familiar contacts, clients, or acquaintances you ran into at a gathering.',
        goal: 'Schedule a face-to-face or virtual catch-up without urgency.'
      },
      {
        name: 'Event Dormant Reconnect Journey',
        bestFor: 'Re-establishing communication with someone from your past network after a long gap.',
        ideal: 'Dormant contacts, former clients, or colleagues from phone/LinkedIn (not tied to a recent event).',
        goal: 'Reopen the relationship with inactive or past contacts.'
      },
      {
        name: 'Event New Contact Follow-Up Journey',
        bestFor: 'Following up with brand-new people met for the first time at an event.',
        ideal: 'Fresh introductions from conferences, trade shows, meetups, or mixers.',
        goal: 'Continue the conversation and explore business potential.'
      },
      {
        name: 'Event Acknowledgment Journey',
        bestFor: 'Lightly acknowledging someone you just met without pushing for a meeting.',
        ideal: 'Casual event contacts, weak-fit prospects, or very early introductions.',
        goal: 'Maintain goodwill without pressure.'
      },
      {
        name: 'Event Urgent Demo Journey',
        bestFor: 'Responding quickly when a lead wants to see a demo.',
        ideal: 'Inbound leads, hot prospects, or people with immediate needs.',
        goal: 'Quickly confirm and schedule a demo.'
      }
    ]
  }
];

/* ---------- Overlay helpers (preserved; not used for new screens) ---------- */
function showSheet(id){ document.getElementById(id).classList.add('show'); }
function closeSheet(id){ document.getElementById(id).classList.remove('show'); }
function overlayClose(e,id){ if(e.target.id===id) closeSheet(id); }

/* ---------- Build accordion UI for new picker screen ---------- */
function openJourneyPicker(){
  buildPickerAccordion();
  navigateTo('screen-picker');
}

/* State for accordion open/close (used by both old/new renders) */
let currentOpen = null;   // index of open category
let currentDetail = null; // {i,j,el}

/* ---------- NEW: Screen Navigation ---------- */
const screens = {
  main: document.getElementById('screen-main'),
  picker: document.getElementById('screen-picker'),
  details: document.getElementById('screen-details'),
  workspace: document.getElementById('screen-workspace')
};
let navStack = ['screen-main']; // simple stack of ids

function updateHeaderVisibility(){
  const header = document.getElementById('mainHeader');
  const topId = navStack[navStack.length - 1];
  // Hide "Contact Details" header on screens 2,3,4
  header.classList.toggle('hidden', topId !== 'screen-main');
}

function navigateTo(id){
  const currentId = navStack[navStack.length - 1];
  if(currentId === id) return;

  const from = document.getElementById(currentId);
  const to = document.getElementById(id);

  // Prepare target off-canvas, ensure visible
  to.classList.remove('hidden','off-left');
  to.classList.add('off-right');

  // double-RAF for smoother start of animation
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    from.classList.add('off-left');
    to.classList.remove('off-right');
  }));

  // After transition completes, hide previous
  setTimeout(()=>{
    from.classList.add('hidden');
    from.classList.remove('off-left');
  }, 380); // keep your global timing (workspace has its own CSS easing/duration)

  navStack.push(id);
  updateHeaderVisibility();
}

function navigateBack(){
  if(navStack.length <= 1) return;
  const fromId = navStack.pop();
  const toId = navStack[navStack.length - 1];

  const from = document.getElementById(fromId);
  const to = document.getElementById(toId);

  to.classList.remove('hidden','off-left','off-right');

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    from.classList.add('off-right');
  }));

  setTimeout(()=>{
    from.classList.add('hidden');
    from.classList.remove('off-right');
  }, 380);

  updateHeaderVisibility();
}

/* ---------- NEW: Build Picker (Screen 2) ---------- */
function buildPickerAccordion(filterText=''){
  const host = document.getElementById('pickerAccordion');
  const query = (filterText || '').trim().toLowerCase();

  const blocks = JOURNEYS.map((block, i) => {
    const catMatch = block.cat.toLowerCase().includes(query);
    const items = block.items.filter(it =>
      !query ||
      catMatch ||
      it.name.toLowerCase().includes(query)
    );

    if(!items.length) return '';

    // When searching: render expanded, without any fold/unfold animation/effects
    const searching = !!query;
    const panelAttrs = searching ? `class="acc-panel" style="max-height:none;transition:none;padding-top:0;padding-bottom:0"` : `class="acc-panel"`;
    const accClasses = searching ? `acc open` : `acc`;

    return `
      <div class="${accClasses}" data-idx="${i}">
        <div class="acc-head" onclick="toggleCategoryPicker(${i})" aria-expanded="${searching ? 'true' : 'false'}">
          <div class="acc-title">${block.cat}</div>
          <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
        </div>
        <div ${panelAttrs}>
          ${items.map((it)=>`
            <div class="jitem" onclick="openJourneyDetails(${i}, ${getOriginalIndex(i,it.name)})">
              <div class="name">${it.name}</div>
              <button class="add-btn small" onclick="event.stopPropagation(); promptAddFromPicker(${i}, ${getOriginalIndex(i,it.name)})">Add to Journey</button>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }).join('');

  host.innerHTML = blocks;

  // During search we DO NOT auto-fold/unfold or animate. When not searching, preserve normal behavior.
  currentOpen = null;
}

/* Helper to find original index j by name within category i */
function getOriginalIndex(i, name){
  return JOURNEYS[i].items.findIndex(it => it.name === name);
}

/* Smooth accordion open/close with simultaneous folding of the other open one (on user tap only) */
function toggleCategoryPicker(i){
  const accs = document.querySelectorAll('#pickerAccordion .acc');
  const acc = document.querySelector(`#pickerAccordion .acc[data-idx="${i}"]`);
  if(!acc) return;

  const isSearching = (document.getElementById('journeySearch').value || '').trim().length > 0;
  if(isSearching){
    // While searching, categories stay open and do not animate.
    return;
  }

  if(currentOpen !== null && currentOpen !== i){
    setOpenPicker(currentOpen, false);
    setOpenPicker(i, true);
    currentOpen = i;
  }else{
    const isOpen = acc.classList.contains('open');
    setOpenPicker(i, !isOpen);
    currentOpen = !isOpen ? i : null;
  }
}

/* Measure-and-animate helper */
function setOpenPicker(i, open, immediate=false){
  const acc = document.querySelector(`#pickerAccordion .acc[data-idx="${i}"]`);
  if(!acc) return;
  const head = acc.querySelector('.acc-head');
  const panel = acc.querySelector('.acc-panel');

  if(open){
    acc.classList.add('open');
    head.setAttribute('aria-expanded','true');
    panel.style.paddingTop = '0px'; panel.style.paddingBottom = '0px';
    panel.style.maxHeight = panel.scrollHeight + 'px';
    if(immediate){
      panel.addEventListener('transitionend', function onEnd(e){
        if(e.propertyName === 'max-height'){
          panel.style.maxHeight = 'none';
          panel.removeEventListener('transitionend', onEnd);
        }
      });
    }else{
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        panel.style.maxHeight = panel.scrollHeight + 'px';
      }));
      panel.addEventListener('transitionend', function onEnd(e){
        if(e.propertyName === 'max-height'){
          panel.style.maxHeight = 'none';
          panel.removeEventListener('transitionend', onEnd);
        }
      });
    }
  }else{
    head.setAttribute('aria-expanded','false');
    if(getComputedStyle(panel).maxHeight === 'none'){
      panel.style.maxHeight = panel.scrollHeight + 'px';
    }
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      panel.style.maxHeight = '0px';
    }));
    acc.classList.remove('open');
  }
}

/* Search behavior (no fold/unfold effects during search) */
document.getElementById('journeySearch').addEventListener('input', (e)=>{
  buildPickerAccordion(e.target.value);
});

/* ---------- NEW: Journey Details (Screen 3) ---------- */
let detailsContext = {i:null,j:null};

function openJourneyDetails(i,j){
  detailsContext = {i,j};
  const data = JOURNEYS[i].items[j];
  document.getElementById('detailsTitle').textContent = 'Journey Details';
  document.getElementById('detailsName').textContent = data.name;
  document.getElementById('detailsBestFor').textContent = data.bestFor;
  document.getElementById('detailsIdeal').textContent = data.ideal;
  document.getElementById('detailsGoal').textContent = data.goal;

  // Build milestones list for this journey
  buildMilestones(data.name);

  navigateTo('screen-details');
}

function buildMilestones(journeyName){
  const list = document.getElementById('milestonesList');
  const defs = (JOURNEY_PHASES[journeyName] || JOURNEY_PHASES._default);
  const today = new Date().toISOString().slice(0,10);
  list.innerHTML = defs.map((p, idx)=>`
    <div class="milestone-row">
      <div class="milestone-title">${p.title}</div>
      <div class="milestone-input">
        <label style="font-size:12px;color:#667085">Estimated Completion Date:</label>
        <input type="date" data-milestone="${idx}" value="${today}" />
      </div>
    </div>
  `).join('');

  // default journey est also today +14 for convenience
  const jEst = document.getElementById('journeyEstInput');
  const dt = new Date(); dt.setDate(dt.getDate()+14);
  jEst.value = dt.toISOString().slice(0,10);
}

/* Add journey from details screen -> FINAL SUBMISSION now */
document.getElementById('detailsAddBtn').addEventListener('click', ()=>{
  const {i,j} = detailsContext;
  if(i===null || j===null) return;
  const data = JOURNEYS[i].items[j];

  // collect overall journey estimated date
  const est = document.getElementById('journeyEstInput').value || '';

  addJourneyToCard(data.name, est);
  flashToast(`Added â€œ${data.name}â€ to this contact.`);

  // Return to main screen
  // details -> (back to) main
  navigateBack(); // to picker
  setTimeout(()=>navigateBack(), 30); // to main
});

/* Cancel button on details screen */
document.getElementById('detailsCancelBtn').addEventListener('click', navigateBack);

/* Back buttons for new screens */
document.getElementById('pickerBackBtn').addEventListener('click', navigateBack);
document.getElementById('detailsBackBtn').addEventListener('click', navigateBack);
document.getElementById('workspaceBackBtn').addEventListener('click', ()=> {
  navigateBack();
});

/* ---------- Add from Picker (Screen 2 button) ---------- */
/* Do NOT submit; go to screen 3 and smooth-snap to Milestones with a pulse highlight */
function snapToMilestones(){
  const container = document.querySelector('#screen-details .details-body');
  const target = document.getElementById('milestonesSection');
  if(!container || !target) return;

  const cr = container.getBoundingClientRect();
  const tr = target.getBoundingClientRect();
  const delta = tr.top - cr.top + container.scrollTop;

  // Smooth programmatic scroll (falls back to instant if unsupported)
  if (typeof container.scrollTo === 'function'){
    container.scrollTo({ top: delta, behavior: 'smooth' });
  } else {
    container.scrollTop = delta;
  }

  // Obvious snap cue: pulse highlight on the Milestones card
  target.classList.remove('snap-highlight'); // reset if already present
  // slight delay so the highlight begins after scroll starts
  setTimeout(()=>{ 
    target.classList.add('snap-highlight'); 
    // auto-clean the class after animation ends or after 1.2s fallback
    const cleanup = ()=>target.classList.remove('snap-highlight');
    target.addEventListener('animationend', cleanup, { once:true });
    setTimeout(cleanup, 1200);
  }, 120);
}

function promptAddFromPicker(i,j){
  openJourneyDetails(i,j);
  // wait for slide transition + layout, then smooth-snap inside the details scroll container
  setTimeout(()=>{ snapToMilestones(); }, 420);
}

/* ---------- Main card list management ---------- */
const selectedJourneys = []; // {name, est}

function addJourneyToCard(name, estDate){
  selectedJourneys.push({name, est: estDate || ''});
  renderJourneyList();
}

function renderJourneyList(){
  const list = document.getElementById('journeyList');
  const placeholder = document.getElementById('journeyPlaceholder');

  if(selectedJourneys.length === 0){
    list.style.display = 'none';
    placeholder.style.display = '';
    return;
  }

  // Hide empty-state text once we have at least one journey
  placeholder.style.display = 'none';

  list.style.display = 'block';
  list.innerHTML = selectedJourneys.map((j,idx)=>{
    return `<li data-jdx="${idx}">
      <span>${j.name}</span>
      <button class="secondary-btn mini-btn view-btn" data-view="${idx}">View Journey</button>
    </li>`;
  }).join('');
}

/* View Journey button -> open workspace */
document.getElementById('journeyList').addEventListener('click', (e)=>{
  const btn = e.target.closest('[data-view]');
  if(!btn) return;
  const idx = parseInt(btn.getAttribute('data-view'),10);
  const j = selectedJourneys[idx];
  if(!j) return;
  openWorkspace(j.name);
});

/* ---------- Old overlay detail helpers (preserved; not used now) ---------- */
function toggleCategory(i){
  if(currentOpen !== null && currentOpen !== i){
    setOpen(currentOpen, false);
  }
  const willOpen = currentOpen !== i;
  setOpen(i, willOpen);
  currentOpen = willOpen ? i : null;
  if(willOpen && currentDetail && currentDetail.i !== i){
    removeDetail();
  }
}
function setOpen(i, open){
  const acc = document.querySelector(`.acc[data-idx="${i}"]`);
  if(!acc) return;
  acc.classList.toggle('open', open);
}
function revealJourney(i,j,evt){
  if(currentDetail && currentDetail.i===i && currentDetail.j===j){
    removeDetail(); return;
  }
  removeDetail();

  const acc = document.querySelector(`.acc[data-idx="${i}"]`);
  const panel = acc.querySelector('.acc-panel');
  const items = panel.querySelectorAll('.jitem');
  const anchor = items[j];

  const data = JOURNEYS[i].items[j];
  const detail = document.createElement('div');
  detail.className = 'jdetail';
  detail.innerHTML = `
    <div class="h">${data.name}</div>
    <div class="p"><strong>Best For:</strong> ${data.bestFor}</div>
    <div class="p"><strong>Ideal Contacts:</strong> ${data.ideal}</div>
    <div class="p"><strong>Goal:</strong> ${data.goal}</div>
    <button class="add-btn" onclick="addJourney('${data.name.replace(/'/g,"\\'")}')">Add to Journey</button>
  `;
  anchor.insertAdjacentElement('afterend', detail);
  currentDetail = {i,j,el:detail};

  setTimeout(() => {
    detail.scrollIntoView({behavior:'smooth', block:'end'});
  }, 0);
}
function removeDetail(){
  if(currentDetail && currentDetail.el){
    currentDetail.el.remove();
  }
  currentDetail = null;
}
function addJourney(name){
  closeSheet('journeyOverlay');
  flashToast(`Added â€œ${name}â€ to this contact.`);
}

/* improved toast (more visible) */
let toastTimer;
function flashToast(text){
  let t = document.getElementById('seg-toast');
  if(!t){
    t = document.createElement('div');
    t.id = 'seg-toast';
    t.style.position='absolute';
    t.style.top='calc(var(--status-h) + 10px)';
    t.style.left='50%';
    t.style.transform='translateX(-50%) translateY(-120%)';
    t.style.background='#0B1F3F';
    t.style.color='#fff';
    t.style.padding='10px 16px';
    t.style.borderRadius='12px';
    t.style.fontSize='13px';
    t.style.fontWeight='800';
    t.style.boxShadow='0 10px 24px rgba(0,0,0,.22)';
    t.style.transition='transform .25s ease, opacity .25s ease';
    t.style.opacity='0';
    t.style.zIndex='1000';
    document.querySelector('.phone').appendChild(t);
  }
  t.textContent = text;
  t.style.opacity='1';
  t.style.transform='translateX(-50%) translateY(0)';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{
    t.style.opacity='0';
    t.style.transform='translateX(-50%) translateY(-120%)';
  }, 2000);
}

/* ---------- NEW: Date Modal logic ---------- */
/* (removed per request) */

/* open the picker (wired from main screen link) */
document.getElementById('addJourneyLink').addEventListener('click', openJourneyPicker);

// ======== NEW: Journey Workspace logic (phases + tasks) ========

/* Full phases & tasks mapping */
const JOURNEY_PHASES = {
  'Event High-Value Sales Meeting Journey': [
    { title:'Automated Priority Outreach', tasks:[] },
    { title:'Manual Direct Outreach', tasks:[{ name:'Personalized high-touch message/call', status:'Queued' }] },
    { title:'Scheduling', tasks:[] },
    { title:'High-Value Session', tasks:[] },
  ],
  'Event Warm Reconnect Journey': [
    { title:'Automated Messaging Outreach', tasks:[] },
    { title:'Manual Personal Outreach', tasks:[{ name:'Casual follow-up note or call', status:'Queued' }] },
    { title:'Time Coordination', tasks:[] },
    { title:'Follow-Up Meeting', tasks:[] },
  ],
  'Event Dormant Reconnect Journey': [
    { title:'Automated Reconnect Outreach', tasks:[] },
    { title:'Manual Memory Outreach', tasks:[{ name:'Personal reminder of past contact', status:'Queued' }] },
    { title:'Calendar Setup', tasks:[] },
    { title:'Reconnection Meeting', tasks:[] },
  ],
  'Event New Contact Follow-Up Journey': [
    { title:'Automated Event Outreach', tasks:[] },
    { title:'Manual Context Outreach', tasks:[{ name:'Manual message referencing event conversation', status:'Queued' }] },
    { title:'Scheduling Coordination', tasks:[] },
    { title:'Networking Session', tasks:[] },
  ],
  'Event Acknowledgment Journey': [
    { title:'Automated Appreciation Outreach', tasks:[] },
    { title:'Manual 30-Day Check-In', tasks:[] },
  ],
  'Event Urgent Demo Journey': [
    { title:'Automated Rapid Outreach', tasks:[] },
    { title:'Manual Urgency Outreach', tasks:[{ name:'Confirm urgency with quick manual touchpoint', status:'Queued' }] },
    { title:'Demo Scheduling', tasks:[] },
    { title:'Demo Session', tasks:[] },
  ],
  'Cold/General Meeting Request Journey': [
    { title:'Automated Introductory Outreach', tasks:[] },
    { title:'Manual Engagement Outreach', tasks:[{ name:'Light manual follow-up (call, DM)', status:'Queued' }] },
    { title:'Appointment Setting', tasks:[] },
    { title:'Discovery Session', tasks:[] },
  ],
  'Business Card Reactivate Journey': [
    { title:'Automated Reactivation Outreach', tasks:[] },
    { title:'Manual Follow-Up Outreach', tasks:[{ name:'Personalized message or call to reintroduce yourself', status:'Queued' }] },
    { title:'Scheduling a Time', tasks:[] },
    { title:'Reconnection Session', tasks:[] },
  ],
  '_default': [
    { title:'Phase 1', tasks:[] },
    { title:'Phase 2', tasks:[] },
    { title:'Phase 3', tasks:[] },
    { title:'Phase 4', tasks:[] },
  ]
};

/* per-journey runtime state */
const journeyState = new Map(); // journeyName -> { phases:[{title,status,startedAt,completedAt,tasks:[{name,status}]}], openIdx }

/* ensure state with first phase Started, others Not Begun */
function ensureJourneyState(journeyName){
  if(journeyState.has(journeyName)) return journeyState.get(journeyName);
  const def = JOURNEY_PHASES[journeyName] || JOURNEY_PHASES._default;
  const phases = def.map((p, idx)=>({
    title: p.title,
    status: idx===0 ? 'Started' : 'Not Begun',
    startedAt: idx===0 ? todayISO() : '',
    completedAt: '',
    tasks: (p.tasks||[]).map(t=>({ name:t.name, status:t.status||'Queued' }))
  }));
  const st = { phases, openIdx: findFirstOpenIdx(phases) };
  journeyState.set(journeyName, st);
  return st;
}

function todayISO(){ return new Date().toISOString().slice(0,10); }

function findFirstOpenIdx(phases){
  // default open = first not Completed
  const idx = phases.findIndex(p => p.status !== 'Completed');
  return idx === -1 ? 0 : idx;
}

function openWorkspace(journeyName){
  const st = ensureJourneyState(journeyName);
  document.getElementById('workspaceTitle').textContent = journeyName;
  renderWorkspace(journeyName);
  navigateTo('screen-workspace'); // slides in (workspace screen has 280ms ease-in-out via CSS class)
}

function renderWorkspace(journeyName){
  const host = document.getElementById('workspaceBody');
  const st = journeyState.get(journeyName);
  if(!st || !st.phases || st.phases.length===0){
    host.innerHTML = `<div class="card" style="margin:12px">
        <div class="card-title">No phases yet</div>
        <div class="card-body">No phases yet. Add journeys and phases here.</div>
      </div>`;
    return;
  }

  host.innerHTML = st.phases.map((p,idx)=>{
    const isOpen = st.openIdx === idx;
    const statusLine = p.status==='Started'
      ? `Status: Started â€¢ Started: ${p.startedAt||todayISO()}`
      : `Status: ${p.status}`;
    const right = p.status==='Started'
      ? `<button class="phase-complete-btn" data-complete="${idx}">Complete Phase</button>`
      : `<span class="phase-pill">${p.status}</span>`;

    const tasksHTML = (p.tasks && p.tasks.length)
      ? p.tasks.map((t,tidx)=>`
          <div class="task" data-task="${idx}:${tidx}">
            <div class="left">
              <div class="title">${t.name}</div>
              <div class="status">Status: ${t.status}</div>
            </div>
            <div class="right">
              ${t.status!=='Completed' ? `<button class="start-btn" data-start="${idx}:${tidx}">Start</button>` : ``}
              <button class="menu-btn" data-menu="${idx}:${tidx}"><span class="kebab"></span></button>
            </div>
          </div>
        `).join('')
      : `<div class="task" style="border-top:0;padding-top:0"><div class="left"><div class="status">No tasks in this phase.</div></div></div>`;

    return `
      <div class="phase-card" data-phase="${idx}">
        <div class="phase-head" data-toggle="${idx}">
          <div>
            <div class="phase-title">${p.title}</div>
            <div class="phase-meta">${statusLine}</div>
          </div>
          <div class="phase-right">
            ${right}
          </div>
        </div>
        <div class="phase-panel ${isOpen?'open':''}" style="max-height:${isOpen? '999px':'0'}">
          ${tasksHTML}
        </div>
      </div>
    `;
  }).join('');

  // bind handlers (event delegation)
  host.onclick = (e)=>{
    const completeBtn = e.target.closest('[data-complete]');
    if(completeBtn){
      const idx = parseInt(completeBtn.getAttribute('data-complete'),10);
      completePhase(journeyName, idx);
      return;
    }
    const toggle = e.target.closest('[data-toggle]');
    if(toggle){
      const idx = parseInt(toggle.getAttribute('data-toggle'),10);
      togglePhaseOpen(journeyName, idx);
      return;
    }
    const startBtn = e.target.closest('[data-start]');
    if(startBtn){
      const [pIdx,tIdx] = startBtn.getAttribute('data-start').split(':').map(n=>parseInt(n,10));
      openTaskModal(journeyName, pIdx, tIdx);
      return;
    }
    const menuBtn = e.target.closest('[data-menu]');
    if(menuBtn){
      const [pIdx,tIdx] = menuBtn.getAttribute('data-menu').split(':').map(n=>parseInt(n,10));
      openTaskMenu(menuBtn, journeyName, pIdx, tIdx);
      return;
    }
  };
}

function togglePhaseOpen(journeyName, idx){
  const st = journeyState.get(journeyName);
  if(!st) return;
  if(st.openIdx === idx) return; // only one open at a time
  const host = document.getElementById('workspaceBody');
  // close previous
  const prev = host.querySelector(`.phase-card[data-phase="${st.openIdx}"] .phase-panel`);
  if(prev){
    prev.style.maxHeight = prev.scrollHeight+'px'; // set current height to animate close
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      prev.classList.remove('open');
      prev.style.maxHeight = '0';
    }));
  }
  // open new
  const next = host.querySelector(`.phase-card[data-phase="${idx}"] .phase-panel`);
  if(next){
    next.style.maxHeight = next.scrollHeight+'px';
    next.classList.add('open');
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      next.style.maxHeight = '999px';
    }));
  }
  st.openIdx = idx;
}

function completePhase(journeyName, idx){
  const st = journeyState.get(journeyName);
  if(!st) return;
  const p = st.phases[idx];
  if(!p) return;
  p.status = 'Completed';
  p.completedAt = todayISO();

  // Start next phase if any
  const nextIdx = idx + 1;
  if(st.phases[nextIdx]){
    const np = st.phases[nextIdx];
    if(np.status !== 'Completed'){
      np.status = 'Started';
      np.startedAt = todayISO();
      st.openIdx = nextIdx; // open next
    }
  }
  flashToast(`Phase ${idx+1} completed.`);
  renderWorkspace(journeyName);
}

/* ===== Smart Task modal ===== */
let taskCtx = null; // {journey, pIdx, tIdx}

function openTaskModal(journeyName, pIdx, tIdx){
  taskCtx = {journey:journeyName, pIdx, tIdx};
  const st = journeyState.get(journeyName);
  if(!st) return;
  const task = st.phases[pIdx]?.tasks[tIdx];
  if(!task) return;

  document.getElementById('taskModalTitle').textContent = task.name;
  document.getElementById('taskModalMeta').textContent = `Phase: ${st.phases[pIdx].title} â€¢ Current status: ${task.status}`;
  document.getElementById('taskNotes').value = '';

  const modal = document.getElementById('taskModal');
  modal.classList.add('show'); // slides up (250ms)
}

function closeTaskModal(){
  const modal = document.getElementById('taskModal');
  modal.classList.remove('show');
  taskCtx = null;
}

document.getElementById('taskSave').addEventListener('click', ()=>{
  if(!taskCtx) return closeTaskModal();
  const st = journeyState.get(taskCtx.journey);
  const t = st?.phases[taskCtx.pIdx]?.tasks[taskCtx.tIdx];
  if(t){
    if(t.status==='Queued' || t.status==='Paused' || t.status==='Cancelled'){
      t.status = 'Started'; // "Save" keeps as Started if it wasn't
    }
  }
  renderWorkspace(taskCtx.journey);
  closeTaskModal();
});

document.getElementById('taskComplete').addEventListener('click', ()=>{
  if(!taskCtx) return closeTaskModal();
  const st = journeyState.get(taskCtx.journey);
  const t = st?.phases[taskCtx.pIdx]?.tasks[taskCtx.tIdx];
  if(t){
    t.status = 'Completed';
  }
  renderWorkspace(taskCtx.journey);
  closeTaskModal();
});

/* ===== Task 3-dot menu ===== */
let activeMenuEl = null;

function openTaskMenu(anchorEl, journeyName, pIdx, tIdx){
  closeTaskMenu(); // ensure only one
  const menu = document.createElement('div');
  menu.className = 'menu-pop';
  menu.innerHTML = `
    <button data-act="Start">Start task</button>
    <button data-act="Assign">Assign task</button>
    <button data-act="Completed">Complete task</button>
    <button data-act="Queued">Queue task</button>
    <button data-act="Cancelled">Cancel task</button>
    <button data-act="Paused">Pause task</button>
  `;
  document.body.appendChild(menu);
  activeMenuEl = menu;

  const rect = anchorEl.getBoundingClientRect();
  const phoneRect = document.querySelector('.phone').getBoundingClientRect();
  const left = phoneRect.left + rect.left - phoneRect.left - 172;
  const top = phoneRect.top + rect.top - phoneRect.top + 28;
  menu.style.left = Math.max(12, left) + 'px';
  menu.style.top = Math.max(12, top) + 'px';

  const closeOnAny = (ev)=>{
    if(menu.contains(ev.target)) return;
    document.removeEventListener('click', closeOnAny);
    closeTaskMenu();
  };
  setTimeout(()=>document.addEventListener('click', closeOnAny),0);

  menu.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.getAttribute('data-act');
    applyTaskStatus(journeyName, pIdx, tIdx, act);
    closeTaskMenu();
  });
}

function closeTaskMenu(){
  if(activeMenuEl){
    activeMenuEl.remove();
    activeMenuEl = null;
  }
}

function applyTaskStatus(journeyName, pIdx, tIdx, act){
  const st = journeyState.get(journeyName);
  const t = st?.phases[pIdx]?.tasks[tIdx];
  if(!t) return;
  if(act==='Assign'){
    flashToast('Assign flow coming soon');
    return;
  }
  if(['Start','Queued','Cancelled','Paused','Completed'].includes(act)){
    t.status = (act==='Start') ? 'Started' : act;
    renderWorkspace(journeyName);
  }
}

/* open the picker (wired from main screen link) */
document.getElementById('addJourneyLink').addEventListener('click', openJourneyPicker);

// initialize header visibility on load
updateHeaderVisibility();
</script>
</body>
</html>
